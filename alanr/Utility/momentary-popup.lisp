(in-package :ccl);; ****************************************************************;;;; Author: Alan Ruttenberg, MIT Media Lab;; email:  alanr@media.mit.edu;;;; Friday May 24,1996 alanr: Added ability to show icons in menu items. Icons need to be in the range ;;  of ids 256-512. Icon name should be fourth item in the menu entry list.;; pop-up-menu-with-submenu-actions allows submenus to have menu-item-actions;;;; momentary pop-up-menu pops up a pop-up menu. Built on pop-up-menu,;; which is intended as a dialog item. Thanks to williams for better version vis.;;   Williams patches get around messy redraw when pop-up is removed.;;   How? pop-up-menus, as shipped, are meant to be a dialog item, which when clicked gives;;   the pop-up-menu. In our case we want the pop-up-menu itself to pop up, hence "no-dialog-item";;   Also, validate-corners prevents the refresh event since menus save their bits behind them;;   by default.;;;; Wednesday November 27,1996 alanr: MCL wants to have at least on of the items to be the default and;;   thus checked. Disable this.;; Monday October 23,1995: Fix bug when selecting items from submenu. now *momentary-menu-popping-up* is;;  bound to the top level menu, and chosen-menu-item is stored on that menu.;; Thursday August 10,1995 alanr: allow submenus in pop-up-momentary-menu-from-alist. ;;   It assumes that if an entry has a third element then that third element is a alist of submenu entries;; Tuesday August 8,1995 alanr: if we pass a menu item to pop-up-momentary-menu-from-alist then use it.;; Thursday July 27,1995: alanr made the menu item action be called after the popup ;; menu is removed. That way, the popup menu can make the assumption that nothing;; else has been drawn below it, and so validate the region it covered. ;; ;; Friday March 24,1995: alanr added unwind-protect to guarantee that pop-up is ;;  removed from view when we are done with it.;; Created: Monday March 6,1995;; ;; ****************************************************************(defclass momentary-pop-up-menu (pop-up-menu-with-submenu-actions)  ((chosen-menu-item :initarg :chosen-menu-item :initform nil :accessor chosen-menu-item)))(defmethod view-draw-contents ((v momentary-pop-up-menu)));; Wednesday November 27,1996 alanr: MCL wants to have at least on of the items to be the default and;;   thus checked. Disable this.(defmethod set-pop-up-menu-default-item ((m momentary-pop-up-menu) num)  (declare (ignore num))  nil)(defvar *momentary-menu-popping-up* nil)(defclass menu-item-with-delayed-action (menu-item) ())(defclass momentary-menu-item (menu-item-with-delayed-action)   ((menu-item-icon :initarg :menu-item-icon :initform nil :accessor menu-item-icon)))    (defmethod menu-item-action ((v menu-item-with-delayed-action))  (if *momentary-menu-popping-up*    (setf (chosen-menu-item *momentary-menu-popping-up*) v)    (call-next-method v)))(defun pop-up-momentary-menu (view menu-items)  (assert (every #'(lambda(i) (or (typep i 'momentary-menu-item)                                  (typep i 'menu))) menu-items) ()          "Menu items used in pop-up-momentary-menu need to have class menu-item-action mixed in")  (let ((it (make-instance 'momentary-pop-up-menu              :view-position (view-mouse-position (view-window view))              :menu-items menu-items)))    (unwind-protect (let ((*momentary-menu-popping-up* it))                      (set-view-container it (view-window view))                      (view-click-event-handler it (view-mouse-position (view-window view))))      (set-view-container it nil))    (when (view-window view)      (validate-corners (view-window view)                        (view-position it) (add-points (view-position it) (view-size it))))    (window-update-event-handler (view-window view))    (when (chosen-menu-item it)      (menu-item-action (chosen-menu-item it))      (setf (chosen-menu-item it) nil))    ));; entries are like `("test" #'(lambda() (test arg)));; an entry can also be a momentary-menu-item(defun pop-up-momentary-menu-from-alist (view string-function-pairs &key font)  (pop-up-momentary-menu    view   (convert-momentary-alist-to-menu-items string-function-pairs :font font)));; alanr Friday May 24,1996. Let fourth item be icon to put in menu item.(defun convert-momentary-alist-to-menu-items (string-function-pairs &key font)  (declare (ignore font))  (loop for entry  in string-function-pairs        collect (if (consp entry)                  (let ((item (if (= (length entry) 3)                                (make-instance 'menu                                   :menu-title (first entry)                                  ;:menu-item-action (second entry)                                  :menu-items (convert-momentary-alist-to-menu-items (third entry)))                                (make-instance 'momentary-menu-item :menu-item-title (first entry)                                               :menu-item-action (second entry)))))                    (when (fourth entry)                       (setf (menu-item-icon item) (cicn-id (cicn-named (fourth entry)))))                    item)                  entry)))